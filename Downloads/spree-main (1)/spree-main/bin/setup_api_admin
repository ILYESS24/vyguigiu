#!/usr/bin/env ruby
require 'fileutils'

puts "ğŸš€ Configuration Spree API-Admin Only"
puts "=" * 50

# VÃ©rification des prÃ©requis
puts "ğŸ“‹ VÃ©rification des prÃ©requis..."

begin
  # VÃ©rifier Ruby
  ruby_version = RUBY_VERSION
  puts "âœ… Ruby #{ruby_version}"

  # VÃ©rifier Bundler
  `bundle --version`
  puts "âœ… Bundler OK"
rescue
  puts "âŒ Bundler non installÃ©. Installez avec: gem install bundler"
  exit 1
end

# Installation des gems
puts "\nğŸ“¦ Installation des gems..."
system("bundle install") || exit(1)

# Configuration des variables d'environnement
puts "\nğŸ”§ Configuration des variables d'environnement..."

env_file = ".env"
unless File.exist?(env_file)
  env_content = <<~ENV
    # Base de donnÃ©es
    DATABASE_URL=postgres://spree:password@localhost:5432/spree_admin_db

    # Redis
    REDIS_URL=redis://localhost:6379/0
    REDIS_CACHE_URL=redis://localhost:6379/1

    # Rails
    SECRET_KEY_BASE=#{`bin/rails secret`.strip}
    RAILS_ENV=development
    RAILS_LOG_LEVEL=info
    RAILS_MAX_THREADS=1

    # Spree
    DEVISE_SESSION_TIMEOUT=60
  ENV

  File.write(env_file, env_content)
  puts "âœ… Fichier .env crÃ©Ã©"
else
  puts "â„¹ï¸  Fichier .env existe dÃ©jÃ "
end

# CrÃ©ation de la base de donnÃ©es
puts "\nğŸ—„ï¸  Configuration de la base de donnÃ©es..."
system("bin/rails db:create") || puts("âš ï¸  Impossible de crÃ©er la DB (PostgreSQL pas configurÃ©?)")
system("bin/rails db:migrate") || exit(1)
system("bin/rails db:seed") || exit(1)

puts "\nğŸ‰ Installation terminÃ©e!"
puts ""
puts "ğŸŒ AccÃ¨s :"
puts "   Admin: http://localhost:3000/admin"
puts "   API:   http://localhost:3000/api/v2"
puts ""
puts "ğŸ‘¤ Compte admin par dÃ©faut:"
puts "   Email: admin@example.com"
puts "   Password: password"
puts ""
puts "ğŸš€ Lancez avec: bin/rails server"
puts ""
puts "ğŸ“– Documentation: voir API_ADMIN_README.md"
